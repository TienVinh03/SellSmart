<%- include('../layouts/main.ejs') %>
<div class="main-content">
    <h1 class="text-center mb-4">Quản lý nhập kho</h1>

    <!-- Nút thêm sản phẩm mới -->
    <div class="mb-4 text-end">
        <button class="btn btn-primary" onclick="openAddModal()">
            <i class="fas fa-plus"></i> Nhập sản phẩm mới
        </button>
        <button class="btn btn-success ms-2" onclick="openBatchModal()">
            <i class="fas fa-boxes"></i> Nhập lô hàng mới
        </button>
    </div>

    <!-- Danh sách sản phẩm trong kho -->
    <div>
        <table id="inventoryTable" class="table table-hover">
            <thead>
                <tr>
                    <th scope="col" class="text-center">STT</th>
                    <th scope="col">Tên sản phẩm</th>
                    <th scope="col">Mã sản phẩm</th>
                    <th scope="col">Danh mục</th>
                    <th scope="col">Nhà cung cấp</th>
                    <th scope="col" class="text-center">Tổng tồn kho</th>
                    <th scope="col" class="text-center">Giá</th>
                    <th scope="col" class="text-center">Trạng thái</th>
                    <th scope="col" class="text-center">Thao tác</th>
                </tr>
            </thead>
            <tbody>
                <% inventories.forEach((item, index) => { %>
                    <tr>
                        <td class="text-center"><%= index + 1 %></td>
                        <td><%= item.product_name %></td>
                        <td><%= item.product_code %></td>
                        <td><%= item.typeProduct_id?.name || 'N/A' %></td>
                        <td><%= item.provider_id?.fullName || 'N/A' %></td>
                        <td class="text-center">
                            <span class="badge bg-info">
                                <%= item.total_quantity %> cái
                            </span>
                        </td>
                        <td class="text-end">
                            <% if (item.hasVariants && item.variantDetails && item.variantDetails.length > 0) { %>
                                <% 
                                    const prices = item.variantDetails.map(v => v.price);
                                    const minPrice = Math.min(...prices);
                                    const maxPrice = Math.max(...prices);
                                %>
                                <span class="text-primary">
                                    <%= minPrice.toLocaleString('vi-VN') %> - <%= maxPrice.toLocaleString('vi-VN') %> đ
                                </span>
                            <% } else { %>
                                <span class="text-primary">
                                    <%= item.total_price.toLocaleString('vi-VN') %> đ
                                </span>
                            <% } %>
                        </td>
                        <td class="text-center">
                            <% if (item.status === 'available') { %>
                                <span class="badge bg-success">Còn hàng</span>
                            <% } else { %>
                                <span class="badge bg-danger">Hết hàng</span>
                            <% } %>
                        </td>
                        <td class="text-center">
                            <button type="button" class="btn btn-sm btn-warning" onclick="editInventory('<%= item._id %>')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-primary" onclick="viewDetails('<%= item._id %>')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-danger" onclick="deleteInventory('<%= item._id %>')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                <% }); %>
            </tbody>
        </table>
    </div>

    <!-- Modal thêm sản phẩm mới -->
    <div id="addInventoryModal" class="modal fade" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Nhập sản phẩm mới</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addInventoryForm">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Tên sản phẩm</label>
                                <input type="text" class="form-control" id="addProductName" required maxlength="100">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Danh mục</label>
                                <select class="form-select" id="addTypeProduct" required>
                                    <option value="">Chọn danh mục</option>
                                    <% typeProducts.forEach(type => { %>
                                        <option value="<%= type._id %>"><%= type.name %></option>
                                    <% }); %>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Nhà cung cấp</label>
                                <select class="form-select" id="addProvider" required>
                                    <option value="">Chọn nhà cung cấp</option>
                                    <% providers.forEach(provider => { %>
                                        <option value="<%= provider._id %>"><%= provider.fullName %></option>
                                    <% }); %>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Số lô hàng</label>
                                <input type="text" class="form-control" id="addBatchNumber" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ngày nhập lô</label>
                                <input type="date" class="form-control" id="addBatchDate" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Thuộc tính</label>
                                <input type="hidden" id="variantDetails" name="variantDetails">
                                <button type="button" class="btn btn-outline-secondary w-100" onclick="openVariantSelection()">
                                    <i class="fas fa-list me-2"></i>Chọn thuộc tính
                                </button>
                                <div id="selectedVariantDisplay" class="mt-2"></div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Đơn vị tính</label>
                                <input type="text" class="form-control" id="addUnit" value="cái" required>
                            </div>
                        </div>
                        <div class="row common-fields">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Số lượng</label>
                                <input type="number" class="form-control" id="addQuantity" name="quantity" min="1" step="1" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Giá đơn vị</label>
                                <input type="number" class="form-control" id="addPrice" name="price" min="0.01" step="0.01" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mô tả sản phẩm</label>
                            <textarea class="form-control" id="addProductDescription" rows="3" maxlength="500"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ghi chú</label>
                            <textarea class="form-control" id="addNote" rows="2" maxlength="200"></textarea>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input has-variants" id="hasVariants" name="hasVariants">
                                <label class="form-check-label" for="hasVariants">Sản phẩm có biến thể</label>
                            </div>
                        </div>
                        <div class="variants-section d-none">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">Biến thể sản phẩm</h5>
                                <button type="button" class="btn btn-primary select-variant">
                                    <i class="fas fa-plus"></i> Chọn thuộc tính
                                </button>
                            </div>
                            <div class="variants-list">
                                <div class="variant-item mb-3 d-none">
                                    <div class="row align-items-center">
                                        <div class="col-md-4">
                                            <input type="text" class="form-control variant-attribute" readonly>
                                        </div>
                                        <div class="col-md-3">
                                            <input type="number" class="form-control variant-quantity" placeholder="Số lượng" required>
                                        </div>
                                        <div class="col-md-3">
                                            <input type="number" class="form-control variant-price" placeholder="Giá" required>
                                        </div>
                                        <div class="col-md-2">
                                            <button type="button" class="btn btn-danger remove-variant">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" id="addSubmitBtn" disabled>Lưu</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal nhập lô hàng -->
    <div class="modal fade" id="batchImportModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nhập lô hàng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="batchImportForm">
                        <!-- Thông tin lô hàng -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">Thông tin lô hàng</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label class="form-label">Mã lô hàng <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="batchNumber" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Ngày nhập <span class="text-danger">*</span></label>
                                        <input type="date" class="form-control" id="batchDate" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Ghi chú</label>
                                        <input type="text" class="form-control" id="batchNote">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Danh sách sản phẩm -->
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">Danh sách sản phẩm</h6>
                                <button type="button" class="btn btn-primary btn-sm" id="addProductBtn">
                                    <i class="fas fa-plus"></i> Thêm sản phẩm
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="productsList">
                                    <!-- Template sản phẩm đầu tiên -->
                                    <div class="product-item card mb-3">
                                        <div class="card-body">
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <label class="form-label">Tên sản phẩm <span class="text-danger">*</span></label>
                                                    <input type="text" class="form-control product-name" required>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Mã sản phẩm</label>
                                                    <input type="text" class="form-control product-code">
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Danh mục <span class="text-danger">*</span></label>
                                                    <select class="form-select product-category" required>
                                                        <option value="">Chọn danh mục</option>
                                                        <% typeProducts.forEach(type => { %>
                                                            <option value="<%= type._id %>"><%= type.name %></option>
                                                        <% }); %>
                                                    </select>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Nhà cung cấp <span class="text-danger">*</span></label>
                                                    <select class="form-select product-provider" required>
                                                        <option value="">Chọn nhà cung cấp</option>
                                                        <% providers.forEach(provider => { %>
                                                            <option value="<%= provider._id %>"><%= provider.fullName %></option>
                                                        <% }); %>
                                                    </select>
                                                </div>
                                                <div class="col-md-6 common-fields">
                                                    <label class="form-label">Số lượng <span class="text-danger">*</span></label>
                                                    <input type="number" class="form-control product-quantity" min="1" required>
                                                </div>
                                                <div class="col-md-6 common-fields">
                                                    <label class="form-label">Giá <span class="text-danger">*</span></label>
                                                    <input type="number" class="form-control product-price" min="0" required>
                                                </div>
                                                <div class="col-12">
                                                    <div class="form-check">
                                                        <input type="checkbox" class="form-check-input has-variants" id="productHasVariants-1">
                                                        <label class="form-check-label" for="productHasVariants-1">
                                                            Sản phẩm có biến thể
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-12 variants-section d-none">
                                                    <div class="card">
                                                        <div class="card-header d-flex justify-content-between align-items-center">
                                                            <h6 class="mb-0">Biến thể sản phẩm</h6>
                                                            <button type="button" class="btn btn-primary select-variant">
                                                                <i class="fas fa-plus"></i> Chọn thuộc tính
                                                            </button>
                                                        </div>
                                                        <div class="card-body">
                                                            <div class="variants-list">
                                                                <!-- Variants will be added here -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" id="saveBatchBtn">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal chỉnh sửa sản phẩm -->
    <div id="editInventoryModal" class="modal fade" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">Chỉnh sửa sản phẩm</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editInventoryForm">
                        <input type="hidden" id="editInventoryId">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Tên sản phẩm</label>
                                <input type="text" class="form-control" id="editProductName" required maxlength="100">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Mã sản phẩm</label>
                                <input type="text" class="form-control" id="editProductCode" required pattern="^MD\d+$">
                                <small class="form-text text-muted">Mã sản phẩm phải bắt đầu bằng 'MD' và theo sau là số</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Đơn vị</label>
                                <input type="text" class="form-control" id="editUnit" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Số lô hàng</label>
                                <input type="text" class="form-control" id="editBatchNumber" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ngày nhập lô</label>
                                <input type="date" class="form-control" id="editBatchDate" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Danh mục</label>
                                <select class="form-select" id="editTypeProduct" required>
                                    <option value="">Chọn danh mục</option>
                                    <% typeProducts.forEach(type => { %>
                                        <option value="<%= type._id %>"><%= type.name %></option>
                                    <% }); %>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Nhà cung cấp</label>
                                <select class="form-select" id="editProvider" required>
                                    <option value="">Chọn nhà cung cấp</option>
                                    <% providers.forEach(provider => { %>
                                        <option value="<%= provider._id %>"><%= provider.fullName %></option>
                                    <% }); %>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Thuộc tính</label>
                                <input type="hidden" id="editVariantDetails" name="variantDetails">
                                <button type="button" class="btn btn-outline-secondary w-100" onclick="openVariantSelection()">
                                    <i class="fas fa-list me-2"></i>Chọn thuộc tính
                                </button>
                                <div id="editSelectedVariantDisplay" class="mt-2"></div>
                            </div>
                        </div>
                        <div class="row edit-common-fields">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Số lượng</label>
                                <input type="number" class="form-control" id="editQuantity" min="1" step="1" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Giá đơn vị</label>
                                <input type="number" class="form-control" id="editPrice" min="0.01" step="0.01" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mô tả sản phẩm</label>
                            <textarea class="form-control" id="editProductDescription" rows="3" maxlength="500"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ghi chú</label>
                            <textarea class="form-control" id="editNote" rows="2" maxlength="200"></textarea>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input has-variants" id="editHasVariants" name="editHasVariants">
                                <label class="form-check-label" for="editHasVariants">Sản phẩm có biến thể</label>
                            </div>
                        </div>
                        <div class="variants-section d-none">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">Biến thể sản phẩm</h5>
                                <button type="button" class="btn btn-primary select-variant">
                                    <i class="fas fa-plus"></i> Chọn thuộc tính
                                </button>
                            </div>
                            <div class="variants-list">
                                <div class="variant-item mb-3 d-none">
                                    <div class="row align-items-center">
                                        <div class="col-md-4">
                                            <input type="text" class="form-control variant-attribute" readonly>
                                        </div>
                                        <div class="col-md-3">
                                            <input type="number" class="form-control variant-quantity" placeholder="Số lượng" required>
                                        </div>
                                        <div class="col-md-3">
                                            <input type="number" class="form-control variant-price" placeholder="Giá" required>
                                        </div>
                                        <div class="col-md-2">
                                            <button type="button" class="btn btn-danger remove-variant">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-warning" id="editSubmitBtn" disabled>Lưu thay đổi</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Chi tiết sản phẩm -->
    <div class="modal fade" id="productDetailModal" tabindex="-1" aria-labelledby="productDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productDetailModalLabel">Chi tiết sản phẩm</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Thông tin cơ bản -->
                        <div class="col-12 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Thông tin cơ bản</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>Tên sản phẩm:</strong> <span id="detailProductName"></span></p>
                                            <p><strong>Mã sản phẩm:</strong> <span id="detailProductCode"></span></p>
                                            <p><strong>Loại sản phẩm:</strong> <span id="detailProductType"></span></p>
                                            <p><strong>Nhà cung cấp:</strong> <span id="detailProvider"></span></p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>Số lô:</strong> <span id="detailBatchNumber"></span></p>
                                            <p><strong>Ngày nhập:</strong> <span id="detailBatchDate"></span></p>
                                            <p><strong>Tổng số lượng:</strong> <span id="detailTotalQuantity"></span></p>
                                            <p><strong>Tổng giá trị:</strong> <span id="detailTotalPrice"></span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Chi tiết biến thể -->
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Chi tiết biến thể</h6>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-info" id="noVariantsAlert" style="display: none;">
                                        Sản phẩm này không có biến thể.
                                    </div>
                                    <table class="table table-bordered table-hover" id="variantDetailsTable">
                                        <thead>
                                            <tr>
                                                <th>Thuộc tính</th>
                                                <th class="text-end">Giá</th>
                                                <th class="text-center">Số lượng</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Variants -->
    <div class="modal fade" id="variantsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Quản lý biến thể</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Chọn biến thể</label>
                                <select class="form-select" id="variantSelect">
                                    <option value="">-- Chọn biến thể --</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Giá trị</label>
                                <select class="form-select" id="variantValueSelect" disabled>
                                    <option value="">-- Chọn giá trị --</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" id="addVariantBtn" disabled>Thêm</button>
                </div>
            </div>
        </div>
    </div>

    
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    $(document).ready(function() {
        // Load providers for all provider selects
        loadProviders();
        
        // Function to load providers
        function loadProviders() {
            $.get('/providers/json', function(response) {
                if (response.status === 'Ok') {
                    const providers = response.data;
                    // Update all provider selects
                    $('.product-provider, #addProvider, #editProvider').each(function() {
                        const $select = $(this);
                        $select.empty().append('<option value="">Chọn nhà cung cấp</option>');
                        providers.forEach(provider => {
                            $select.append(`<option value="${provider._id}">${provider.fullName}</option>`);
                        });
                    });
                } else {
                    showErrorToast('Lỗi khi tải danh sách nhà cung cấp');
                }
            }).fail(function() {
                showErrorToast('Không thể kết nối đến server');
            });
        }

        // Add product button handler
        $('#addProductBtn').click(function() {
            const productTemplate = `
                <div class="product-item card mb-3">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Tên sản phẩm</label>
                                <input type="text" class="form-control product-name" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Mã sản phẩm</label>
                                <input type="text" class="form-control product-code" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Danh mục</label>
                                <select class="form-select product-category" required>
                                    <option value="">Chọn danh mục</option>
                                    <% typeProducts.forEach(function(type) { %>
                                        <option value="<%= type._id %>"><%= type.name %></option>
                                    <% }); %>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Nhà cung cấp</label>
                                <select class="form-select product-provider" required>
                                    <option value="">Chọn nhà cung cấp</option>
                                </select>
                            </div>
                            
                            <div class="col-12">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input has-variants" id="productHasVariants-${Date.now()}">
                                    <label class="form-check-label" for="productHasVariants-${Date.now()}">Sản phẩm có biến thể</label>
                                </div>
                            </div>

                            <div class="col-12 common-fields">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">Số lượng</label>
                                        <input type="number" class="form-control product-quantity" min="1" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Giá</label>
                                        <input type="number" class="form-control product-price" min="0" required>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 variants-section d-none">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">Biến thể sản phẩm</h6>
                                        <button type="button" class="btn btn-primary select-variant">
                                            <i class="fas fa-plus"></i> Chọn thuộc tính
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div class="variants-list">
                                            <!-- Variants will be added here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer text-end">
                        <button type="button" class="btn btn-danger btn-sm remove-product">
                            <i class="fas fa-trash"></i> Xóa sản phẩm
                        </button>
                    </div>
                </div>
            `;
            
            $('#productsList').append(productTemplate);
            // Reload providers for the new select
            loadProviders();
        });

        // Remove product handler
        $(document).on('click', '.remove-product', function() {
            $(this).closest('.product-item').remove();
        });

        // Thêm event listener để nhận message từ trang variants
        window.addEventListener('message', function(event) {
            console.log('Nhận được dữ liệu từ trang variants:', event.data);
            
            if (event.data && event.data.selectedVariants) {
                const variants = event.data.selectedVariants;
                if (window.currentProductItem) {
                    const $variantsList = window.currentProductItem.find('.variants-list');
                    $variantsList.empty(); // Xóa các biến thể cũ
                    
                    variants.forEach(variant => {
                        // Check if variant already exists
                        const existingVariant = $variantsList.find(`[data-variant-id="${variant.id}"]`);
                        if (existingVariant.length > 0) {
                            return; // Skip if already exists
                        }

                        // Create variant text from attributes
                        const variantText = Object.entries(variant.attributes)
                            .map(([key, value]) => `${key}: ${value}`)
                            .join(', ');

                        // Create new variant item
                        const variantItem = document.createElement('div');
                        variantItem.className = 'variant-item mb-3 p-3 border rounded';
                        variantItem.dataset.variantId = variant.id;

                        variantItem.innerHTML = `
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <strong>Thuộc tính:</strong> ${variantText}
                                    <input type="hidden" name="variants[${variant.id}][attributes]" value='${JSON.stringify(variant.attributes)}'>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group mb-0">
                                        <label>Số lượng:</label>
                                        <input type="number" name="variants[${variant.id}][quantity]" class="form-control" required min="0">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group mb-0">
                                        <label>Giá:</label>
                                        <input type="number" name="variants[${variant.id}][price]" class="form-control" required min="0">
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-danger" onclick="removeVariant(this)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `;

                        $variantsList.append(variantItem);
                    });
                }
            }
        });

        // Xử lý xóa tổ hợp biến thể
        $(document).on('click', '.delete-variant-combination', function() {
            $(this).closest('.variant-combination').remove();
        });

        // Handle select variant button click
        $(document).on('click', '.select-variant', function() {
            const $productItem = $(this).closest('.product-item');
            const typeProductId = $productItem.find('.product-category').val();
            
            if (!typeProductId) {
                alert('Vui lòng chọn danh mục sản phẩm trước khi thêm biến thể');
                return;
            }

            // Store reference to current product
            window.currentProductItem = $productItem;
            
            // Open variants page in new window
            const variantsWindow = window.open('/products/variants?mode=select&typeProductId=' + typeProductId, 'VariantsWindow', 'width=800,height=600');
            if (variantsWindow) {
                variantsWindow.focus();
            } else {
                alert('Trình duyệt đã chặn popup. Vui lòng cho phép popup để sử dụng tính năng này.');
            }
        });

        // Xử lý khi submit form
        $('#saveBatchBtn').click(function() {
            const batchInfo = {
                batch_number: $('#batchNumber').val(),
                import_date: $('#batchDate').val(),
                provider_id: $('.product-provider').first().val(),
                note: $('#batchNote').val()
            };

            const products = [];

            $('.product-item').each(function() {
                const $product = $(this);
                const hasVariants = $product.find('.has-variants').is(':checked');
                
                const productData = {
                    product_name: $product.find('.product-name').val(),
                    typeProduct_id: $product.find('.product-category').val(),
                    product_description: '',
                    unit: 'cái',
                    hasVariants: hasVariants
                };

                if (hasVariants) {
                    const variants = [];
                    $product.find('.variant-combination').each(function() {
                        const $combination = $(this);
                        const attributes = {};
                        
                        // Collect all variant data from this combination
                        $combination.find('.variant-data').each(function() {
                            const name = $(this).data('variant-name');
                            const value = $(this).data('variant-value');
                            attributes[name] = value;
                        });

                        variants.push({
                            attributes: attributes,
                            quantity: Number($combination.find('.variant-quantity').val()),
                            price: Number($combination.find('.variant-price').val())
                        });
                    });
                    productData.variants = variants;
                } else {
                    productData.quantity = Number($product.find('.product-quantity').val());
                    productData.price = Number($product.find('.product-price').val());
                }

                products.push(productData);
            });

            // Validate required fields
            if (!batchInfo.batch_number || !batchInfo.import_date || !batchInfo.provider_id) {
                alert('Vui lòng điền đầy đủ thông tin lô hàng');
                return;
            }

            if (products.length === 0) {
                alert('Vui lòng thêm ít nhất một sản phẩm');
                return;
            }

            // Validate each product
            for (const product of products) {
                if (!product.product_name || !product.typeProduct_id) {
                    alert('Vui lòng điền đầy đủ thông tin cho tất cả sản phẩm');
                    return;
                }

                if (product.hasVariants) {
                    if (!product.variants || product.variants.length === 0) {
                        alert('Vui lòng thêm ít nhất một biến thể cho sản phẩm có biến thể');
                        return;
                    }
                    for (const variant of product.variants) {
                        if (!variant.quantity || !variant.price || !variant.attributes) {
                            alert('Vui lòng điền đầy đủ thông tin cho tất cả biến thể');
                            return;
                        }
                    }
                } else {
                    if (!product.quantity || !product.price) {
                        alert('Vui lòng điền đầy đủ số lượng và giá cho sản phẩm');
                        return;
                    }
                }
            }

            // Gửi dữ liệu lên server
            $.ajax({
                url: '/inventory/batch-import',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    batchInfo: batchInfo,
                    products: products
                }),
                success: function(response) {
                    if (response.status === 'Success') {
                        alert('Nhập lô hàng thành công');
                        $('#batchImportModal').modal('hide');
                        location.reload();
                    } else {
                        alert(response.message || 'Có lỗi xảy ra khi nhập lô hàng');
                    }
                },
                error: function(xhr) {
                    const errorMessage = xhr.responseJSON?.message || 'Có lỗi xảy ra khi nhập lô hàng';
                    alert('Lỗi: ' + errorMessage);
                }
            });
        });

        // Thêm lại hàm openBatchModal
        window.openBatchModal = function() {
            // Reset form
            $('#batchImportForm')[0].reset();
            $('#productsList').html(''); // Xóa tất cả sản phẩm cũ
            
            // Thêm sản phẩm đầu tiên
            const $productTemplate = `
                <div class="product-item card mb-3">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Tên sản phẩm</label>
                                <input type="text" class="form-control product-name" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Mã sản phẩm</label>
                                <input type="text" class="form-control product-code" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Danh mục</label>
                                <select class="form-select product-category" required>
                                    <option value="">Chọn danh mục</option>
                                    <% typeProducts.forEach(function(type) { %>
                                        <option value="<%= type._id %>"><%= type.name %></option>
                                    <% }); %>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Nhà cung cấp</label>
                                <select class="form-select product-provider" required>
                                    <option value="">Chọn nhà cung cấp</option>
                                </select>
                            </div>
                            
                            <div class="col-12">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input has-variants" id="productHasVariants">
                                    <label class="form-check-label" for="productHasVariants">Sản phẩm có biến thể</label>
                                </div>
                            </div>

                            <div class="col-12 common-fields">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">Số lượng</label>
                                        <input type="number" class="form-control product-quantity" min="1" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Giá</label>
                                        <input type="number" class="form-control product-price" min="0" required>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 variants-section d-none">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">Biến thể sản phẩm</h6>
                                        <button type="button" class="btn btn-primary select-variant">
                                            <i class="fas fa-plus"></i> Chọn thuộc tính
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div class="variants-list">
                                            <!-- Variants will be added here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            $('#productsList').append($productTemplate);
            
            // Hiển thị modal
            $('#batchImportModal').modal('show');
        };

        // Xử lý checkbox biến thể
        $(document).on('change', '.has-variants', function() {
            const $productItem = $(this).closest('.product-item');
            const $variantsSection = $productItem.find('.variants-section');
            const $commonFields = $productItem.find('.common-fields');
            
            if ($(this).is(':checked')) {
                $variantsSection.removeClass('d-none');
                $commonFields.addClass('d-none');
            } else {
                $variantsSection.addClass('d-none');
                $commonFields.removeClass('d-none');
            }
        });

        // Thêm sản phẩm mới
        $('#addProductBtn').click(function() {
            const $productTemplate = $('.product-item').first().clone();
            $productTemplate.find('input, select').val('');
            $productTemplate.find('.variants-list').empty();
            $productTemplate.find('.has-variants').prop('checked', false);
            $productTemplate.find('.variants-section').addClass('d-none');
            $productTemplate.find('.common-fields').removeClass('d-none');
            $('#productsList').append($productTemplate);
        });

        // Function to handle variant selection
        function openVariantSelection() {
            const variantWindow = window.open('/variants/select', 'variantSelection', 'width=800,height=600');
            
            // Store reference to current window
            window.variantSelectionOpener = window;
        }

        // Function to receive variants from the variant selection window
        function receiveVariants(variants) {
            if (!variants || !Array.isArray(variants)) {
                console.error('Invalid variants data received');
                return;
            }

            const variantsList = document.getElementById('variantsList');
            if (!variantsList) {
                console.error('Variants list container not found');
                return;
            }

            variants.forEach(variant => {
                // Check if variant already exists
                const existingVariant = variantsList.querySelector(`[data-variant-id="${variant.id}"]`);
                if (existingVariant) {
                    return; // Skip if variant already exists
                }

                // Create variant text from attributes
                const variantText = Object.entries(variant.attributes)
                    .map(([key, value]) => `${key}: ${value}`)
                    .join(', ');

                // Create new variant item
                const variantItem = document.createElement('div');
                variantItem.className = 'variant-item mb-3 p-3 border rounded';
                variantItem.dataset.variantId = variant.id;

                variantItem.innerHTML = `
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <strong>Thuộc tính:</strong> ${variantText}
                            <input type="hidden" name="variants[${variant.id}][attributes]" value='${JSON.stringify(variant.attributes)}'>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group mb-0">
                                <label>Số lượng:</label>
                                <input type="number" name="variants[${variant.id}][quantity]" class="form-control" required min="0">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group mb-0">
                                <label>Giá:</label>
                                <input type="number" name="variants[${variant.id}][price]" class="form-control" required min="0">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-danger" onclick="removeVariant(this)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;

                variantsList.appendChild(variantItem);
            });
        }

        function removeVariant(button) {
            const variantItem = button.closest('.variant-item');
            if (variantItem) {
                variantItem.remove();
            }
        }

        // Xử lý khi mở modal nhập lô hàng mới
        $('#batchImportModal').on('show.bs.modal', function() {
            // Reset form
            $('#batchImportForm')[0].reset();
            
            // Đặt ngày mặc định là ngày hiện tại
            const today = new Date().toISOString().split('T')[0];
            $('#batchDate').val(today);
            
            // Tạo mã lô hàng mặc định
            const batchNumber = 'BH' + Date.now().toString().slice(-6);
            $('#batchNumber').val(batchNumber);
            
            // Load danh sách nhà cung cấp nếu chưa có
            if ($('.product-provider option').length <= 1) {
                loadProviders();
            }
        });

        // Định dạng số theo chuẩn Việt Nam
        const formatNumber = (number) => {
            return new Intl.NumberFormat('vi-VN').format(number);
        };

        // Định dạng tiền tệ theo chuẩn Việt Nam
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        };

        // Định nghĩa hàm viewDetails trong phạm vi toàn cục
        window.viewDetails = async function(productId) {
            const modal = new bootstrap.Modal(document.getElementById('productDetailModal'));
            modal.show();

            try {
                // Gọi API lấy thông tin chi tiết
                const response = await fetch(`/inventory/${productId}`, {
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Không thể tải thông tin sản phẩm');
                }

                const data = await response.json();
                
                if (data.status === 'Ok' && data.inventory) {
                    const inventory = data.inventory;

                    // Cập nhật thông tin cơ bản
                    document.getElementById('detailProductName').textContent = inventory.product_name;
                    document.getElementById('detailProductCode').textContent = inventory.product_code;
                    document.getElementById('detailProductType').textContent = inventory.typeProduct_id?.name || 'N/A';
                    document.getElementById('detailProvider').textContent = inventory.provider_id?.fullName || 'N/A';
                    document.getElementById('detailBatchNumber').textContent = inventory.batch_number;
                    document.getElementById('detailBatchDate').textContent = new Date(inventory.batch_date).toLocaleDateString('vi-VN');
                    document.getElementById('detailTotalQuantity').textContent = new Intl.NumberFormat('vi-VN').format(inventory.total_quantity);
                    document.getElementById('detailTotalPrice').textContent = new Intl.NumberFormat('vi-VN', {
                        style: 'currency',
                        currency: 'VND'
                    }).format(inventory.total_price);

                    // Xử lý hiển thị biến thể
                    const variantTable = document.getElementById('variantDetailsTable');
                    const noVariantsAlert = document.getElementById('noVariantsAlert');
                    const tbody = variantTable.querySelector('tbody');
                    tbody.innerHTML = '';

                    if (inventory.variantDetails && inventory.variantDetails.length > 0) {
                        variantTable.style.display = 'table';
                        noVariantsAlert.style.display = 'none';

                        inventory.variantDetails.forEach(variant => {
                            const row = tbody.insertRow();
                            
                            // Cột thuộc tính
                            const attributeCell = row.insertCell();
                            const attributes = Object.entries(variant.attributes)
                                .map(([name, value]) => `${name}: ${value}`)
                                .join(', ');
                            attributeCell.textContent = attributes;

                            // Cột giá
                            const priceCell = row.insertCell();
                            priceCell.textContent = new Intl.NumberFormat('vi-VN', {
                                style: 'currency',
                                currency: 'VND'
                            }).format(variant.price);
                            priceCell.classList.add('text-end');

                            // Cột số lượng
                            const quantityCell = row.insertCell();
                            quantityCell.textContent = new Intl.NumberFormat('vi-VN').format(variant.quantity);
                            quantityCell.classList.add('text-center');
                        });
                    } else {
                        variantTable.style.display = 'none';
                        noVariantsAlert.style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Lỗi khi tải chi tiết sản phẩm:', error);
                alert('Có lỗi xảy ra khi tải thông tin sản phẩm. Vui lòng thử lại sau.');
            }
        };

        // Khởi tạo các thành phần khi trang đã tải xong
        document.addEventListener('DOMContentLoaded', function() {
            // Khởi tạo các toast messages nếu cần
            const toastElList = [].slice.call(document.querySelectorAll('.toast'));
            toastElList.map(function(toastEl) {
                return new bootstrap.Toast(toastEl);
            });
        });

        // Lắng nghe sự kiện message từ cửa sổ popup biến thể
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'VARIANTS_SELECTED') {
                const variants = event.data.variants;
                handleSelectedVariants(variants);
            }
        });

        // Xử lý dữ liệu biến thể từ trang variants
        function handleSelectedVariants(event) {
            if (event.data && event.data.type === 'VARIANTS_SELECTED') {
                const variants = event.data.variants;
                if (variants && variants.length > 0) {
                    // Cập nhật biến thể cho sản phẩm hiện tại
                    const currentProduct = products[currentProductIndex];
                    if (currentProduct) {
                        currentProduct.variants = variants;
                        currentProduct.hasVariants = true;
                        updateProductTable();
                    }
                } else {
                    console.error('Không có biến thể nào được chọn');
                }
            }
        }

        // Hàm hiển thị toast thông báo
        function showErrorToast(message) {
            const toastElement = document.getElementById('errorToast');
            if (toastElement) {
                const toastBody = toastElement.querySelector('.toast-body');
                if (toastBody) {
                    toastBody.textContent = message;
                    const toast = new bootstrap.Toast(toastElement);
                    toast.show();
                }
            } else {
                console.error('Toast element not found');
            }
        }

        function showSuccessToast(message) {
            const toastElement = document.getElementById('successToast');
            if (toastElement) {
                const toastBody = toastElement.querySelector('.toast-body');
                if (toastBody) {
                    toastBody.textContent = message;
                    const toast = new bootstrap.Toast(toastElement);
                    toast.show();
                }
            } else {
                console.error('Toast element not found');
            }
        }
    });
    </script>

    <style>
    .variants-list {
        max-height: 400px;
        overflow-y: auto;
        padding: 10px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
    }

    .variant-item {
        background-color: #f8f9fa;
        margin-bottom: 10px;
        padding: 15px;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }

    .variant-item:hover {
        background-color: #e9ecef;
    }

    .variant-item:last-child {
        margin-bottom: 0;
    }

    .card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
    }

    .card-body {
        padding: 1.25rem;
    }

    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    .product-form {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    </style>
</div>