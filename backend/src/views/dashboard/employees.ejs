<%- include('../layouts/main.ejs') %>
<div class="main-content">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="mb-0"><%= title %></h1>
        </div>
        <div class="col-md-4 text-end">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEmployeeModal">
                <i class="fas fa-plus me-2"></i>Thêm nhân viên mới
            </button>
        </div>
    </div>

    <!-- Filter options -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="filterForm" class="row g-3">
                <div class="col-md-4">
                    <label for="statusFilter" class="form-label">Trạng thái</label>
                    <select class="form-select" id="statusFilter">
                        <option value="">Tất cả trạng thái</option>
                        <option value="active">Đang làm việc</option>
                        <option value="inactive">Đã nghỉ việc</option>
                        <option value="leave">Nghỉ phép</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="searchInput" class="form-label">Tìm kiếm</label>
                    <input type="text" class="form-control" id="searchInput"
                           placeholder="Tìm theo tên, mã nhân viên, email...">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-outline-primary w-100" id="applyFilter">
                        <i class="fas fa-filter me-2"></i>Lọc
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Employee List -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                    <tr class="text-center">
                        <th scope="col">STT</th>
                        <th scope="col">Mã NV</th>
                        <th scope="col">Ảnh</th>
                        <th scope="col">Thông tin</th>
                        <th scope="col">Chức vụ</th>
                        <th scope="col">Ngày vào làm</th>
                        <th scope="col">Trạng thái</th>
                        <th scope="col">Thao tác</th>
                    </tr>
                    </thead>
                    <tbody>
                    <% if (employees && employees.length > 0) { %>
                        <% employees.forEach((employee, index) => { %>
                            <tr class="text-center">
                                <td><%= index + 1 %></td>
                                <td><span class="fw-medium"><%= employee.employeeId %></span></td>
                                <td>
                                    <% if (employee.userId && employee.userId.avatar) { %>
                                        <img src="<%= employee.userId.avatar %>" alt="Avatar" class="avatar-sm rounded-circle">
                                    <% } else { %>
                                        <div class="avatar-sm bg-light d-flex align-items-center justify-content-center rounded-circle mx-auto">
                                            <i class="fas fa-user text-secondary"></i>
                                        </div>
                                    <% } %>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center justify-content-center">
                                        <div>
                                            <h6 class="mb-0"><%= employee.userId ? employee.userId.fullName : '' %></h6>
                                            <small class="text-muted">
                                                <i class="fas fa-envelope me-1"></i><%= employee.userId ? employee.userId.email : '' %>
                                            </small><br>
                                            <small class="text-muted">
                                                <i class="fas fa-phone me-1"></i><%= employee.userId ? employee.userId.phoneNumber : '' %>
                                            </small>
                                        </div>
                                    </div>
                                </td>
                                <td><%= employee.position %></td>
                                <td><%= new Date(employee.hireDate).toLocaleDateString('vi-VN') %></td>
                                <td>
                                    <% if (employee.workStatus === 'active') { %>
                                        <span class="badge bg-success">Đang làm việc</span>
                                    <% } else if (employee.workStatus === 'inactive') { %>
                                        <span class="badge bg-danger">Đã nghỉ việc</span>
                                    <% } else if (employee.workStatus === 'leave') { %>
                                        <span class="badge bg-warning text-dark">Nghỉ phép</span>
                                    <% } else { %>
                                        <span class="badge bg-secondary"><%= employee.workStatus %></span>
                                    <% } %>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-info view-btn" data-id="<%= employee.employeeId %>">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-warning edit-btn"
                                            data-id="<%= employee.employeeId %>">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    
                                </td>
                            </tr>
                        <% }); %>
                    <% } else { %>
                        <tr>
                            <td colspan="8" class="text-center py-4">
                                <div class="alert alert-info mb-0">
                                    <i class="fas fa-info-circle me-2"></i>Chưa có dữ liệu nhân viên
                                </div>
                            </td>
                        </tr>
                    <% } %>
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div class="d-flex justify-content-between align-items-center p-3 border-top">
                <div class="d-flex align-items-center">
                    <label class="text-muted me-2">Hiển thị:</label>
                    <select class="form-select form-select-sm" id="itemsPerPage" style="width: auto;">
                        <option value="5">5</option>
                        <option value="10" selected>10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                    </select>
                    <span class="text-muted ms-2">nhân viên</span>
                </div>
                <nav aria-label="Employee navigation">
                    <ul class="pagination pagination-sm mb-0">
                        <li class="page-item" id="prevPage">
                            <a class="page-link" href="#" aria-label="Previous">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <span class="page-link" id="currentPage">1</span>
                        </li>
                        <li class="page-item" id="nextPage">
                            <a class="page-link" href="#" aria-label="Next">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>
                    </ul>
                </nav>
                <div class="text-muted">
                    Tổng số: <span class="fw-semibold" id="totalItems">0</span> nhân viên
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Employee Modal -->
<div class="modal fade" id="addEmployeeModal" tabindex="-1" aria-labelledby="addEmployeeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addEmployeeModalLabel">Thêm nhân viên mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addEmployeeForm" class="needs-validation" novalidate>
                    <div class="row mb-3">
                        <div class="col-12">
                            <h5 class="border-bottom pb-2">Thông tin cơ bản</h5>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="employeeId" class="form-label">Mã nhân viên <span
                                        class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="employeeId" name="employeeId" minlength="3" required>
                            <div class="invalid-feedback">Mã nhân viên phải có ít nhất 3 ký tự</div>
                        </div>
                        <div class="col-md-6">
                            <label for="fullName" class="form-label">Họ và tên <span
                                        class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="fullName" name="fullName" minlength="3" required>
                            <div class="invalid-feedback">Họ và tên phải có ít nhất 3 ký tự</div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="email" name="email" pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$" required>
                            <div class="invalid-feedback">Email phải có định dạng hợp lệ </div>
                        </div>
                        <div class="col-md-6">
                            <label for="phoneNumber" class="form-label">Số điện thoại <span
                                        class="text-danger">*</span></label>
                            <input type="tel" class="form-control" id="phoneNumber" name="phoneNumber" pattern="[0-9]{10,11}" required>
                            <div class="invalid-feedback">Số điện thoại phải là số và có độ dài 10-11 ký tự</div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="gender" class="form-label">Giới tính</label>
                            <select class="form-select" id="gender" name="gender">
                                <option value="male">Nam</option>
                                <option value="female">Nữ</option>
                                <option value="other">Khác</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="dob" class="form-label">Ngày sinh <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="dob" name="dob" required>
                            <div class="invalid-feedback">Vui lòng chọn ngày sinh (phải trên 16 tuổi)</div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="address" class="form-label">Địa chỉ</label>
                            <textarea class="form-control" id="address" name="address" rows="2"></textarea>
                        </div>
                    </div>
                    <!-- Thêm trường avatar -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Avatar</label>
                            <select class="form-select" id="avatarType" name="avatarType">
                                <option value="url">Nhập URL</option>
                                <option value="file">Upload file</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <div id="avatarUrlInput" class="avatar-option">
                                <label for="avatarUrl" class="form-label">URL Avatar</label>
                                <input type="url" class="form-control" id="avatarUrl" name="avatarUrl">
                            </div>
                            <div id="avatarFileInput" class="avatar-option" style="display: none;">
                                <label for="avatarFile" class="form-label">Upload File</label>
                                <input type="file" class="form-control" id="avatarFile" name="avatarFile"
                                       accept="image/*">
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <h5 class="border-bottom pb-2">Thông tin công việc</h5>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="position" class="form-label">Chức vụ <span
                                        class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="position" name="position" required>
                        </div>
                        <div class="col-md-6">
                            <label for="hireDate" class="form-label">Ngày vào làm <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="hireDate" name="hireDate" required>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="workStatus" class="form-label">Trạng thái làm việc <span class="text-danger">*</span></label>
                            <select class="form-select" id="workStatus" name="workStatus" required>
                                <option value="active">Đang làm việc</option>
                                <option value="inactive">Đã nghỉ việc</option>
                                <option value="leave">Nghỉ phép</option>
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <h5 class="border-bottom pb-2">Thông tin đăng nhập</h5>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="username" class="form-label">Tên đăng nhập <span
                                        class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="username" name="username" required>
                        </div>
                        <div class="col-md-6">
                            <label for="password" class="form-label">Mật khẩu <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="saveEmployee">Lưu</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Employee Modal -->
<div class="modal fade" id="editEmployeeModal" tabindex="-1" aria-labelledby="editEmployeeModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editEmployeeModalLabel">Cập nhật thông tin nhân viên</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editEmployeeForm" class="needs-validation" novalidate>
                    <input type="hidden" id="editEmployeeId" name="employeeId">

                    <div class="row mb-3">
                        <div class="col-12">
                            <h5 class="border-bottom pb-2">Thông tin cơ bản</h5>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editFullName" class="form-label">Họ và tên <span
                                        class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editFullName" name="userInfo[fullName]"
                                   minlength="3" required>
                            <div class="invalid-feedback">Họ và tên phải có ít nhất 3 ký tự</div>
                        </div>
                        <div class="col-md-6">
                            <label for="editEmail" class="form-label">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="editEmail" name="userInfo[email]" 
                                   pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$" required>
                            <div class="invalid-feedback">Email phải có định dạng hợp lệ (với @ và .com)</div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editPhoneNumber" class="form-label">Số điện thoại <span
                                        class="text-danger">*</span></label>
                            <input type="tel" class="form-control" id="editPhoneNumber" name="userInfo[phoneNumber]"
                                   pattern="[0-9]{10,11}" required>
                            <div class="invalid-feedback">Số điện thoại phải là số và có độ dài 10-11 ký tự</div>
                        </div>
                        <div class="col-md-6">
                            <label for="editGender" class="form-label">Giới tính</label>
                            <select class="form-select" id="editGender" name="userInfo[gender]">
                                <option value="male">Nam</option>
                                <option value="female">Nữ</option>
                                <option value="other">Khác</option>
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editDob" class="form-label">Ngày sinh <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="editDob" name="userInfo[dob]" required>
                            <div class="invalid-feedback">Vui lòng chọn ngày sinh (phải trên 16 tuổi)</div>
                        </div>
                        <div class="col-md-6">
                            <label for="editAddress" class="form-label">Địa chỉ</label>
                            <input type="text" class="form-control" id="editAddress" name="userInfo[address]">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Avatar</label>
                            <div class="input-group">
                                <select class="form-select" id="editAvatarType" name="userInfo[avatarType]">
                                    <option value="url">Nhập URL</option>
                                    <option value="file">Upload file</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div id="editAvatarUrlInput" class="avatar-option">
                                <label for="editAvatarUrl" class="form-label">URL Avatar</label>
                                <input type="url" class="form-control" id="editAvatarUrl" name="userInfo[avatarUrl]">
                            </div>
                            <div id="editAvatarFileInput" class="avatar-option" style="display: none;">
                                <label for="editAvatarFile" class="form-label">Upload File</label>
                                <input type="file" class="form-control" id="editAvatarFile" name="avatarFile"
                                       accept="image/*">
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <h5 class="border-bottom pb-2">Thông tin công việc</h5>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editPosition" class="form-label">Chức vụ <span
                                        class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editPosition" name="position" required>
                        </div>
                        <div class="col-md-6">
                            <label for="editWorkStatus" class="form-label">Trạng thái làm việc <span
                                    class="text-danger">*</span></label>
                            <select class="form-select" id="editWorkStatus" name="workStatus">
                                <option value="active">Đang làm việc</option>
                                <option value="inactive">Đã nghỉ việc</option>
                                <option value="leave">Nghỉ phép</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="updateEmployee">Lưu thay đổi</button>
            </div>
        </div>
    </div>
</div>

<!-- View Employee Modal -->
<div class="modal fade" id="viewEmployeeModal" tabindex="-1" aria-labelledby="viewEmployeeModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewEmployeeModalLabel">Thông tin chi tiết nhân viên</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <div id="viewEmployeeAvatar" class="mx-auto mb-3"
                         style="width: 100px; height: 100px; border-radius: 50%; background-color: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-user fa-3x text-secondary"></i>
                    </div>
                    <h4 id="viewEmployeeName" class="mb-1">Tên nhân viên</h4>
                    <p id="viewEmployeePosition" class="text-muted mb-0">Chức vụ</p>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-user me-2"></i>Thông tin cá nhân</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <small class="text-muted d-block">Mã nhân viên:</small>
                                    <span id="viewEmployeeId"></span>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted d-block">Email:</small>
                                    <span id="viewEmployeeEmail"></span>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted d-block">Số điện thoại:</small>
                                    <span id="viewEmployeePhone"></span>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted d-block">Giới tính:</small>
                                    <span id="viewEmployeeGender"></span>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted d-block">Ngày sinh:</small>
                                    <span id="viewEmployeeDob"></span>
                                </div>
                                <div class="mb-0">
                                    <small class="text-muted d-block">Địa chỉ:</small>
                                    <span id="viewEmployeeAddress"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-briefcase me-2"></i>Thông tin công việc</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <small class="text-muted d-block">Lương:</small>
                                    <span id="viewEmployeeSalary"></span>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted d-block">Ngày vào làm:</small>
                                    <span id="viewEmployeeHireDate"></span>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted d-block">Trạng thái:</small>
                                    <span id="viewEmployeeStatus"></span>
                                </div>
                                <div class="mb-0">
                                    <small class="text-muted d-block">Số tài khoản:</small>
                                    <span id="viewEmployeeBankAccount"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" id="viewEditEmployee">Chỉnh sửa</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteEmployeeModal" tabindex="-1" aria-labelledby="deleteEmployeeModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteEmployeeModalLabel">Xác nhận xóa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn xóa nhân viên <strong id="deleteEmployeeName"></strong>?</p>
                <p class="text-danger">Lưu ý: Hành động này không thể hoàn tác và sẽ xóa cả tài khoản người dùng liên
                    kết.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Xác nhận xóa</button>
            </div>
        </div>
    </div>
</div>
<!-- Bootstrap and other scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
  $(document).ready(function () {
    $('#avatarType').change(function () {
      if ($(this).val() === 'url') {
        $('#avatarUrlInput').show();
        $('#avatarFileInput').hide();
        $('#avatarFile').val(''); // Reset file input
      } else {
        $('#avatarUrlInput').hide();
        $('#avatarFileInput').show();
        $('#avatarUrl').val(''); // Reset URL input
      }
    });

    $('#editAvatarType').change(function () {
      if ($(this).val() === 'url') {
        $('#editAvatarUrlInput').show();
        $('#editAvatarFileInput').hide();
        $('#editAvatarFile').val('');
      } else {
        $('#editAvatarUrlInput').hide();
        $('#editAvatarFileInput').show();
        $('#editAvatarUrl').val('');
      }
    });
    // Add Employee
    $('#saveEmployee').click(function (event) {
      // Form validation
      const form = document.getElementById('addEmployeeForm');
      
      if (!form.checkValidity()) {
        // Trigger bootstrap validation
        event.preventDefault();
        event.stopPropagation();
        form.classList.add('was-validated');
        return;
      }
      
      // Custom validation
      let isValid = true;
      let errorMessage = '';
      
      // Validate employeeId (at least 3 characters)
      const employeeId = $('#employeeId').val().trim();
      if (employeeId.length < 3) {
        $('#employeeId').addClass('is-invalid');
        isValid = false;
        errorMessage += 'Mã nhân viên phải có ít nhất 3 ký tự.\n';
      } else {
        $('#employeeId').removeClass('is-invalid');
      }
      
      // Validate fullName (at least 3 characters)
      const fullName = $('#fullName').val().trim();
      if (fullName.length < 3) {
        $('#fullName').addClass('is-invalid');
        isValid = false;
        errorMessage += 'Họ và tên phải có ít nhất 3 ký tự.\n';
      } else {
        $('#fullName').removeClass('is-invalid');
      }
      
      // Validate email (must have @ and .com)
      const email = $('#email').val().trim();
      const emailPattern = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
      if (!emailPattern.test(email)) {
        $('#email').addClass('is-invalid');
        isValid = false;
        errorMessage += 'Email phải có định dạng hợp lệ (với @ và tên miền).\n';
      } else {
        $('#email').removeClass('is-invalid');
      }
      
      // Validate phone number (must be numeric and 10-11 digits)
      const phone = $('#phoneNumber').val().trim();
      const phonePattern = /^[0-9]{10,11}$/;
      if (!phonePattern.test(phone)) {
        $('#phoneNumber').addClass('is-invalid');
        isValid = false;
        errorMessage += 'Số điện thoại phải là số và có độ dài 10-11 ký tự.\n';
      } else {
        $('#phoneNumber').removeClass('is-invalid');
      }
      
      // Validate date of birth (required)
      const dob = $('#dob').val();
      if (!dob) {
        $('#dob').addClass('is-invalid');
        isValid = false;
        errorMessage += 'Ngày sinh là bắt buộc.\n';
      } else {
        // Validate employee is at least 16 years old
        const birthDate = new Date(dob);
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const monthDiff = today.getMonth() - birthDate.getMonth();
        
        // Adjust age if birthday hasn't occurred yet this year
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
          age--;
        }
        
        if (age < 16) {
          $('#dob').addClass('is-invalid');
          isValid = false;
          errorMessage += 'Nhân viên phải trên 16 tuổi.\n';
        } else {
          $('#dob').removeClass('is-invalid');
        }
      }
      
      if (!isValid) {
        alert('Vui lòng kiểm tra lại thông tin:\n' + errorMessage);
        return;
      }
      
      const formData = {
        username: $('#username').val(),
        fullName: fullName,
        gender: $('#gender').val(),
        dob: dob,
        address: $('#address').val(),
        email: email,
        phoneNumber: phone,
        password: $('#password').val(),
        role: 'employee',
        employeeId: employeeId,
        position: $('#position').val(),
        hireDate: $('#hireDate').val(),
        workStatus: $('#workStatus').val(),
      };

      $.ajax({
        url: '/employees/create-employee',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function (response) {
          if (response.success) {
            alert('Thêm nhân viên thành công!');
            $('#addEmployeeModal').modal('hide');
            location.reload();
          } else {
            alert('Lỗi: ' + response.message);
          }
        },
        error: function (xhr) {
          const errorMsg = xhr.responseJSON ? xhr.responseJSON.message : 'Đã xảy ra lỗi';
          alert('Lỗi: ' + errorMsg);
        }
      });
    });

    // Edit Employee - Open modal with data
    $('.edit-btn').click(function () {
      const employeeId = $(this).data('id');

      $.ajax({
        url: `/employees/find-employee/${employeeId}`, // Sửa thành find-employee
        type: 'GET',
        success: function (response) {
          if (response.success && response.data) {
            const employee = response.data;
            const user = employee.userId;

            $('#editEmployeeId').val(employee.employeeId);
            $('#editFullName').val(user.fullName);
            $('#editEmail').val(user.email);
            $('#editPhoneNumber').val(user.phoneNumber);
            $('#editGender').val(user.gender || 'male');
            $('#editDob').val(user.dob ? new Date(user.dob).toISOString().split('T')[0] : '');
            $('#editAddress').val(user.address || '');
            $('#editPosition').val(employee.position);
            $('#editWorkStatus').val(employee.workStatus);

            $('#editEmployeeModal').modal('show');
          } else {
            alert('Lỗi: ' + response.message);
          }
        },
        error: function (xhr) {
          const errorMsg = xhr.responseJSON ? xhr.responseJSON.message : 'Không thể tải thông tin nhân viên';
          alert('Lỗi: ' + errorMsg);
        }
      });
    });

    // Update Employee
    $('#updateEmployee').click(function () {
      const form = document.getElementById('editEmployeeForm');
      
      if (!form.checkValidity()) {
        // Trigger bootstrap validation
        form.classList.add('was-validated');
        return;
      }
      
      // Custom validation
      let isValid = true;
      let errorMessage = '';
      
      // Validate fullName (at least 3 characters)
      const fullName = $('#editFullName').val().trim();
      if (fullName.length < 3) {
        $('#editFullName').addClass('is-invalid');
        isValid = false;
        errorMessage += 'Họ và tên phải có ít nhất 3 ký tự.\n';
      } else {
        $('#editFullName').removeClass('is-invalid');
      }
      
      // Validate email (must have @ and .com)
      const email = $('#editEmail').val().trim();
      const emailPattern = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
      if (!emailPattern.test(email)) {
        $('#editEmail').addClass('is-invalid');
        isValid = false;
        errorMessage += 'Email phải có định dạng hợp lệ (với @ và tên miền).\n';
      } else {
        $('#editEmail').removeClass('is-invalid');
      }
      
      // Validate phone number (must be numeric and 10-11 digits)
      const phone = $('#editPhoneNumber').val().trim();
      const phonePattern = /^[0-9]{10,11}$/;
      if (!phonePattern.test(phone)) {
        $('#editPhoneNumber').addClass('is-invalid');
        isValid = false;
        errorMessage += 'Số điện thoại phải là số và có độ dài 10-11 ký tự.\n';
      } else {
        $('#editPhoneNumber').removeClass('is-invalid');
      }
      
      // Validate date of birth (required)
      const dob = $('#editDob').val();
      if (!dob) {
        $('#editDob').addClass('is-invalid');
        isValid = false;
        errorMessage += 'Ngày sinh là bắt buộc.\n';
      } else {
        // Validate employee is at least 16 years old
        const birthDate = new Date(dob);
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const monthDiff = today.getMonth() - birthDate.getMonth();
        
        // Adjust age if birthday hasn't occurred yet this year
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
          age--;
        }
        
        if (age < 16) {
          $('#editDob').addClass('is-invalid');
          isValid = false;
          errorMessage += 'Nhân viên phải trên 16 tuổi.\n';
        } else {
          $('#editDob').removeClass('is-invalid');
        }
      }
      
      if (!isValid) {
        alert('Vui lòng kiểm tra lại thông tin:\n' + errorMessage);
        return;
      }
      
      const formData = {
        userInfo: {
          fullName: $('#editFullName').val(),
          email: $('#editEmail').val(),
          phoneNumber: $('#editPhoneNumber').val(),
          gender: $('#editGender').val(),
          dob: $('#editDob').val(),
          address: $('#editAddress').val(),
        },
        position: $('#editPosition').val(),
        workStatus: $('#editWorkStatus').val(),
      };

      const employeeId = $('#editEmployeeId').val();

      $.ajax({
        url: `/employees/update-employee/${employeeId}`,
        type: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function (response) {
          if (response.success) {
            alert('Cập nhật nhân viên thành công!');
            $('#editEmployeeModal').modal('hide');
            location.reload();
          } else {
            alert('Lỗi: ' + response.message);
          }
        },
        error: function (xhr) {
          const errorMsg = xhr.responseJSON ? xhr.responseJSON.message : 'Đã xảy ra lỗi';
          alert('Lỗi: ' + errorMsg);
        }
      });
    });

    // View Employee - Open modal with data
    $('.view-btn').click(function () {
      const employeeId = $(this).data('id');

      $.ajax({
        url: `/employees/find-employee/${employeeId}`, // Sửa thành find-employee
        type: 'GET',
        success: function (response) {
          if (response.success && response.data) {
            const employee = response.data;
            const user = employee.userId;

            if (user.avatar) {
              $('#viewEmployeeAvatar').html(`<img src="${user.avatar}" alt="Avatar" class="w-100 h-100 rounded-circle object-fit-cover">`);
            } else {
              $('#viewEmployeeAvatar').html('<i class="fas fa-user fa-3x text-secondary"></i>');
            }
            $('#viewEmployeeName').text(user.fullName);
            $('#viewEmployeePosition').text(employee.position);
            $('#viewEmployeeId').text(employee.employeeId);
            $('#viewEmployeeEmail').text(user.email);
            $('#viewEmployeePhone').text(user.phoneNumber || 'N/A');
            $('#viewEmployeeGender').text(user.gender === 'male' ? 'Nam' : user.gender === 'female' ? 'Nữ' : 'Khác');
            $('#viewEmployeeDob').text(user.dob ? new Date(user.dob).toLocaleDateString('vi-VN') : 'N/A');
            $('#viewEmployeeAddress').text(user.address || 'N/A');
            $('#viewEmployeeSalary').text(employee.salary.toLocaleString('vi-VN') + ' VNĐ');
            $('#viewEmployeeHireDate').text(new Date(employee.hireDate).toLocaleDateString('vi-VN'));
            $('#viewEmployeeStatus').html(
              employee.workStatus === 'active' ? '<span class="badge bg-success">Đang làm việc</span>' :
                employee.workStatus === 'inactive' ? '<span class="badge bg-danger">Đã nghỉ việc</span>' :
                  '<span class="badge bg-warning text-dark">Nghỉ phép</span>'
            );
            $('#viewEmployeeBankAccount').text(employee.bankAccount || 'N/A');

            $('#viewEmployeeModal').modal('show');
          } else {
            alert('Lỗi: ' + response.message);
          }
        },
        error: function (xhr) {
          const errorMsg = xhr.responseJSON ? xhr.responseJSON.message : 'Không thể tải thông tin nhân viên';
          alert('Lỗi: ' + errorMsg);
        }
      });
    });

    // View Edit Button - Switch from view to edit modal
    $('#viewEditEmployee').click(function () {
      $('#viewEmployeeModal').modal('hide');
      $('.edit-btn[data-id="' + $('#viewEmployeeId').text() + '"]').click();
    });

    // Delete Employee - Open confirmation modal
    $('.delete-btn').click(function () {
      const employeeId = $(this).data('id');

      $.ajax({
        url: `/employees/find-employee/${employeeId}`,
        type: 'GET',
        success: function (response) {
          if (response.success && response.data) {
            $('#deleteEmployeeName').text(response.data.userId.fullName);
            $('#confirmDelete').data('id', employeeId);
            $('#deleteEmployeeModal').modal('show');
          }
        },
        error: function (xhr) {
          const errorMsg = xhr.responseJSON ? xhr.responseJSON.message : 'Không thể tải thông tin nhân viên';
          alert('Lỗi: ' + errorMsg);
        }
      });
    });

    $('#confirmDelete').click(function () {
      const employeeId = $(this).data('id');

      $.ajax({
        url: `/employees/delete-employee/${employeeId}`,
        type: 'DELETE',
        success: function (response) {
          if (response.success) {
            alert('Xóa nhân viên thành công!');
            $('#deleteEmployeeModal').modal('hide');
            location.reload();
          } else {
            alert('Lỗi: ' + response.message);
          }
        },
        error: function (xhr) {
          const errorMsg = xhr.responseJSON ? xhr.responseJSON.message : 'Đã xảy ra lỗi';
          alert('Lỗi: ' + errorMsg);
        }
      });
    });

    // Pagination implementation
    const pagination = initializePagination({
      itemSelector: 'tbody tr',
      itemsPerPageSelector: '#itemsPerPage',
      prevPageSelector: '#prevPage',
      nextPageSelector: '#nextPage',
      currentPageSelector: '#currentPage',
      totalItemsSelector: '#totalItems',
      itemNameSingular: 'nhân viên',
      itemNamePlural: 'nhân viên',
      onPageChange: function(state) {
        // Update STT numbers for visible rows
        const visibleRows = $('tbody tr:visible');
        visibleRows.each(function(index) {
          const startIndex = (state.currentPageIndex - 1) * state.itemsPerPage;
          $(this).find('td:first').text(startIndex + index + 1);
        });
      }
    });

    // Filter functionality
    $('#applyFilter').click(function () {
      const status = $('#statusFilter').val();
      const search = $('#searchInput').val().toLowerCase();

      // Define filter function
      const filterFn = function(item) {
        const row = $(item);
        const rowStatus = row.find('td:eq(5) .badge').text().toLowerCase();
        const rowSearchText = row.text().toLowerCase();

        const statusMatch = !status || 
                          (status === 'active' && rowStatus.includes('đang làm việc')) ||
                          (status === 'inactive' && rowStatus.includes('đã nghỉ việc')) ||
                          (status === 'leave' && rowStatus.includes('nghỉ phép'));
                          
        const searchMatch = !search || rowSearchText.includes(search);

        return statusMatch && searchMatch;
      };

      // Apply the filter
      pagination.filterItems(filterFn);
    });
  });
</script>
