<%- include('../layouts/main.ejs') %>
<div class="main-content p-4">
    <div class="container">
        <h1 class="text-center mb-4 fw-bold" style="color: #343a40;">Danh sách sản phẩm</h1>

        <!-- Nút thêm sản phẩm -->
        <div class="mb-4 text-end">
            <button class="btn btn-primary shadow-sm" data-bs-toggle="modal" data-bs-target="#addProductModal">
                <i class="fas fa-plus me-2"></i>Thêm sản phẩm mới
            </button>
        </div>

        <!-- Filter options -->
        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <form id="filterForm" class="row g-3">
                    <div class="col-md-3">
                        <label for="providerFilter" class="form-label">Nhà cung cấp</label>
                        <select class="form-select" id="providerFilter">
                            <option value="">Tất cả nhà cung cấp</option>
                            <% providers.forEach(provider => { %>
                                <option value="<%= provider._id %>"><%= provider.fullName %></option>
                            <% }); %>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="categoryFilter" class="form-label">Danh mục</label>
                        <select class="form-select" id="categoryFilter">
                            <option value="">Tất cả danh mục</option>
                            <% categories.forEach(category => { %>
                                <option value="<%= category._id %>"><%= category.name %></option>
                            <% }); %>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="statusFilter" class="form-label">Trạng thái</label>
                        <select class="form-select" id="statusFilter">
                            <option value="">Tất cả trạng thái</option>
                            <option value="available">Có sẵn</option>
                            <option value="unavailable">Hết hàng</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="searchInput" class="form-label">Tìm kiếm</label>
                        <input type="text" class="form-control" id="searchInput" placeholder="Tìm theo tên sản phẩm...">
                    </div>
                    <div class="col-12 text-end">
                        <button type="button" class="btn btn-outline-primary" id="applyFilter">
                            <i class="fas fa-filter me-2"></i>Lọc
                        </button>
                        <button type="button" class="btn btn-outline-secondary ms-2" id="resetFilter">
                            <i class="fas fa-undo me-2"></i>Đặt lại
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Danh sách sản phẩm -->
        <div class="card shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="fw-bold text-dark">Tên sản phẩm</th>
                                <th class="fw-bold text-dark">Hình ảnh</th>
                                <th class="fw-bold text-dark">Danh mục</th>
                                <th class="fw-bold text-dark text-center">Trạng thái</th>
                                <th class="fw-bold text-dark">Giá (VNĐ)</th>
                                <th class="fw-bold text-dark">Tồn kho</th>
                                <th class="fw-bold text-dark">Nhà cung cấp</th>
                                <th class="fw-bold text-dark">Bảo hành</th>
                                <th class="fw-bold text-dark">Biến thể</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% products.forEach(product => { %>
                                <% if (product._id) { %>
                                    <tr id="product-row-<%= product._id %>" style="cursor: pointer;" onclick="showProductDetails('<%= product._id %>')">
                                        <td>
                                            <%= product.name || 'N/A' %>
                                        </td>
                                        <td>
                                            <img src="<%= product.thumbnail || 'https://via.placeholder.com/100' %>" 
                                                 alt="<%= product.name || 'Sản phẩm' %>" 
                                                 class="rounded" 
                                                 style="width: 80px; height: 80px; object-fit: cover;">
                                        </td>
                                        <td data-category-id="<%= product.category?._id || '' %>">
                                            <%= product.category?.name || 'Chưa có' %>
                                        </td>
                                        <td class="text-center">
                                            <% if (product.status === 'available') { %>
                                                <i class="fas fa-check-circle text-success me-1"></i>Có sẵn
                                            <% } else { %>
                                                <i class="fas fa-times-circle text-danger me-1"></i>Hết hàng
                                            <% } %>
                                        </td>
                                        <td>
                                            <% if (product.hasVariants && product.detailsVariants?.length > 0) { %>
                                                <% 
                                                    const prices = product.detailsVariants.map(v => v.price).filter(p => p !== undefined);
                                                    const minPrice = Math.min(...prices);
                                                    const maxPrice = Math.max(...prices);
                                                %>
                                                <% if (minPrice === maxPrice) { %>
                                                    <span class="text-success fw-bold"><%= minPrice.toLocaleString() %></span>
                                                <% } else { %>
                                                    <span class="text-success fw-bold"><%= minPrice.toLocaleString() %></span>
                                                    <i class="fas fa-arrow-right mx-1"></i>
                                                    <span class="text-danger fw-bold"><%= maxPrice.toLocaleString() %></span>
                                                <% } %>
                                            <% } else { %>
                                                <span class="text-success fw-bold"><%= product.price?.toLocaleString() || 'N/A' %></span>
                                            <% } %>
                                        </td>
                                        <td>
                                            <% if (product.hasVariants && product.detailsVariants?.length > 0) { %>
                                                <% 
                                                    const inventories = product.detailsVariants.map(v => v.inventory).filter(i => i !== undefined);
                                                    const totalInventory = inventories.reduce((sum, curr) => sum + curr, 0);
                                                    const minInventory = Math.min(...inventories);
                                                    const maxInventory = Math.max(...inventories);
                                                %>
                                                <span class="fw-bold"><%= totalInventory %></span>
                                                <br>
                                                <small>
                                                    (<span class="text-success fw-bold"><%= minInventory %></span>
                                                    <i class="fas fa-arrow-right mx-1"></i>
                                                    <span class="text-danger fw-bold"><%= maxInventory %></span>
                                                    / biến thể)
                                                </small>
                                            <% } else { %>
                                                <span class="fw-bold"><%= product.inventory ?? 'N/A' %></span>
                                            <% } %>
                                        </td>
                                        <td data-provider-id="<%= product.providerId?._id || '' %>">
                                            <%= product.providerId?.fullName || 'Chưa có' %>
                                        </td>
                                        <td>
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-shield-alt me-1"></i>
                                                <%= product.warrantyPeriod || 12 %> tháng
                                            </span>
                                        </td>
                                        <td>
                                            <% if (product.hasVariants && product.detailsVariants?.length > 0) { %>
                                                <span class="badge bg-info">
                                                    <%= product.detailsVariants.length %> biến thể
                                                </span>
                                            <% } else { %>
                                                <span class="text-muted">Không có biến thể</span>
                                            <% } %>
                                        </td>
                                    </tr>
                                <% } %>
                            <% }); %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Modal thêm sản phẩm -->
        <div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="addProductModalLabel">Thêm sản phẩm mới</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addProductForm" enctype="multipart/form-data">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="name" class="form-label fw-bold">Tên sản phẩm</label>
                                    <input type="text" class="form-control" id="name" name="name" placeholder="Nhập tên sản phẩm" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="thumbnail" class="form-label fw-bold">Chọn ảnh</label>
                                    <input type="file" class="form-control" id="thumbnail" name="thumbnail" accept="image/*">
                                    <img id="thumbnailPreview" src="#" alt="Xem trước ảnh" style="display: none; width: 100px; height: 100px; object-fit: cover; margin-top: 10px;">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="category" class="form-label fw-bold">Danh mục</label>
                                    <select class="form-control" id="category" name="category" required>
                                        <option value="">Chọn danh mục</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="providerId" class="form-label fw-bold">Nhà cung cấp</label>
                                    <select class="form-control" id="providerId" name="providerId" required>
                                        <option value="">Chọn nhà cung cấp</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="status" class="form-label fw-bold">Trạng thái</label>
                                    <select class="form-control" id="status" name="status" required>
                                        <option value="available">Có sẵn</option>
                                        <option value="unavailable">Hết hàng</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="warrantyPeriod" class="form-label fw-bold">Thời gian bảo hành (tháng)</label>
                                    <input type="number" class="form-control" id="warrantyPeriod" name="warrantyPeriod" 
                                           value="12" min="1" required>
                                    <small class="text-muted">Mặc định là 12 tháng nếu không nhập</small>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 mb-3" id="priceInventoryFields">
                                    <label for="price" class="form-label fw-bold">Giá (VNĐ)</label>
                                    <input type="number" class="form-control" id="price" name="price" min="0" placeholder="Nhập giá" required>
                                    <label for="inventory" class="form-label fw-bold mt-2">Tồn kho</label>
                                    <input type="number" class="form-control" id="inventory" name="inventory" min="0" placeholder="Nhập số lượng" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label fw-bold">Biến thể</label>
                                    <input type="hidden" id="variantDetails" name="variantDetails">
                                    <button type="button" class="btn btn-outline-secondary w-100" onclick="event.stopPropagation(); openVariantsPage(false)">
                                        <i class="fas fa-list me-2"></i>Chọn biến thể
                                    </button>
                                    <div id="selectedVariantDisplay" class="mt-2 text-muted" style="display: none;"></div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100 mt-3 shadow-sm">Thêm sản phẩm</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal chỉnh sửa sản phẩm -->
        <div class="modal fade" id="editProductModal" tabindex="-1" aria-labelledby="editProductModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-warning text-dark">
                        <h5 class="modal-title" id="editProductModalLabel">Sửa sản phẩm</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editProductForm" enctype="multipart/form-data">
                            <input type="hidden" id="editProductId" name="id">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="editName" class="form-label fw-bold">Tên sản phẩm</label>
                                    <input type="text" class="form-control" id="editName" name="name" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="editThumbnail" class="form-label fw-bold">Chọn ảnh</label>
                                    <input type="file" class="form-control" id="editThumbnail" name="thumbnail" accept="image/*">
                                    <img id="editThumbnailPreview" src="#" alt="Xem trước ảnh" style="display: none; width: 100px; height: 100px; object-fit: cover; margin-top: 10px;">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="editCategory" class="form-label fw-bold">Danh mục</label>
                                    <select class="form-control" id="editCategory" name="category" required>
                                        <option value="">Chọn danh mục</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="editProviderId" class="form-label fw-bold">Nhà cung cấp</label>
                                    <select class="form-control" id="editProviderId" name="providerId" required>
                                        <option value="">Chọn nhà cung cấp</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="editStatus" class="form-label fw-bold">Trạng thái</label>
                                    <select class="form-control" id="editStatus" name="status" required>
                                        <option value="available">Có sẵn</option>
                                        <option value="unavailable">Hết hàng</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="editWarrantyPeriod" class="form-label fw-bold">Thời gian bảo hành (tháng)</label>
                                    <input type="number" class="form-control" id="editWarrantyPeriod" name="warrantyPeriod" 
                                           min="1" required>
                                    <small class="text-muted">Mặc định là 12 tháng nếu không nhập</small>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 mb-3" id="editPriceInventoryFields">
                                    <label for="editPrice" class="form-label fw-bold">Giá (VNĐ)</label>
                                    <input type="number" class="form-control" id="editPrice" name="price" min="0" placeholder="Nhập giá">
                                    <label for="editInventory" class="form-label fw-bold mt-2">Tồn kho</label>
                                    <input type="number" class="form-control" id="editInventory" name="inventory" min="0" placeholder="Nhập số lượng">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label fw-bold">Biến thể</label>
                                    <input type="hidden" id="editVariantDetails" name="variantDetails">
                                    <button type="button" class="btn btn-outline-secondary w-100" onclick="event.stopPropagation(); openVariantsPage(true)">
                                        <i class="fas fa-list me-2"></i>Chọn biến thể
                                    </button>
                                    <div id="editSelectedVariantDisplay" class="mt-2 text-muted" style="display: none;"></div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-warning w-100 mt-3 shadow-sm">Lưu thay đổi</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal nhập giá và tồn kho -->
        <div class="modal fade" id="variantPriceModal" tabindex="-1" aria-labelledby="variantPriceModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-info text-white">
                        <h5 class="modal-title" id="variantPriceModalLabel">Nhập giá và tồn kho</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="variantPriceForm">
                            <div id="variantPriceRows"></div>
                            <button type="submit" class="btn btn-info w-100 mt-3">Xác nhận</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal hiển thị chi tiết sản phẩm -->
        <div class="modal fade" id="productDetailsModal" tabindex="-1" aria-labelledby="productDetailsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-info text-white">
                        <h5 class="modal-title" id="productDetailsModalLabel">Chi tiết sản phẩm</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <img id="productImage" src="#" alt="Hình ảnh sản phẩm" class="img-fluid rounded shadow" style="width: 100%; height: auto; object-fit: cover;">
                            </div>
                            <div class="col-md-8">
                                <h4 id="productName" class="fw-bold mb-3"></h4>
                                <div class="row mb-1">
                                    <div class="col-md-4 fw-bold">Danh mục:</div>
                                    <div class="col-md-8" id="productCategory"></div>
                                </div>
                                <div class="row mb-1">
                                    <div class="col-md-4 fw-bold">Nhà cung cấp:</div>
                                    <div class="col-md-8" id="productProvider"></div>
                                </div>
                                <div class="row mb-1">
                                    <div class="col-md-4 fw-bold">Trạng thái:</div>
                                    <div class="col-md-8" id="productStatus"></div>
                                </div>
                                <div class="row mb-1">
                                    <div class="col-md-4 fw-bold">Bảo hành:</div>
                                    <div class="col-md-8">
                                        <span class="badge bg-warning text-dark" id="productWarranty"></span>
                                    </div>
                                </div>
                                <div class="row mb-1" id="productBasicPriceRow">
                                    <div class="col-md-4 fw-bold">Giá cơ bản:</div>
                                    <div class="col-md-8" id="productPrice"></div>
                                </div>
                                <div class="row mb-1" id="productBasicInventoryRow">
                                    <div class="col-md-4 fw-bold">Tồn kho:</div>
                                    <div class="col-md-8" id="productInventory"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="productVariantsSection">
                            <h5 class="fw-bold mb-3 border-bottom pb-2">Biến thể sản phẩm</h5>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="fw-bold">Tổ hợp biến thể</th>
                                            <th class="fw-bold text-end">Giá (VNĐ)</th>
                                            <th class="fw-bold text-center">Tồn kho</th>
                                            <th class="fw-bold text-center">Trạng thái</th>
                                        </tr>
                                    </thead>
                                    <tbody id="productVariantsBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                        <button type="button" class="btn btn-warning" id="btnEditProductDetail">
                            <i class="fas fa-edit me-1"></i> Sửa sản phẩm
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast thông báo -->
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header bg-success text-white">
                    <strong class="me-auto">Thành công</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body"></div>
            </div>
            <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header bg-danger text-white">
                    <strong class="me-auto">Lỗi</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body"></div>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    let selectedVariantsData = [];
    let isEditMode = false;

    // Tải danh sách dữ liệu cho select
    function loadData(url, selectElementId, fieldName, errorMessage) {
        $.get(url, function(response) {
            if (response.status === 'Ok') {
                const $select = $(selectElementId);
                $select.empty().append(`<option value="">Chọn ${fieldName}</option>`);
                response.data.forEach(item => {
                    $select.append(`<option value="${item._id}">${item[fieldName]}</option>`);
                });
            } else {
                showToast('error', `Lỗi khi tải ${fieldName}: ${response.message}`);
            }
        }).fail(() => showToast('error', `Lỗi khi tải ${fieldName}!`));
    }

    // Hiển thị toast
    function showToast(type, message) {
        const toastId = type === 'success' ? '#successToast' : '#errorToast';
        $(`${toastId} .toast-body`).text(message);
        new bootstrap.Toast($(toastId)).show();
    }

    // Hiển thị/ẩn trường giá và tồn kho
    function togglePriceInventoryFields(hasVariants, isEdit = false) {
        const priceFields = isEdit ? '#editPriceInventoryFields' : '#priceInventoryFields';
        $(priceFields).toggle(!hasVariants);
        $(`${priceFields} input`).prop('required', !hasVariants);
    }

    // Xem trước ảnh
    function previewImage(inputId, previewId) {
        $(inputId).change(function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => $(previewId).attr('src', e.target.result).show();
                reader.readAsDataURL(file);
            }
        });
    }

    // Gửi request AJAX
    function sendAjaxRequest(url, method, formData, successMessage, modalId, callback) {
        $.ajax({
            url,
            type: method,
            data: formData,
            processData: false,
            contentType: false,
            beforeSend: () => $(`${modalId} button[type="submit"]`)
                .prop('disabled', true)
                .html('<i class="fas fa-spinner fa-spin"></i> Đang xử lý...'),
            success: response => {
                if (response.status === 'Ok') {
                    $(modalId).modal('hide');
                    showToast('success', successMessage);
                    if (callback) callback();
                } else {
                    showToast('error', response.message);
                }
            },
            error: xhr => showToast('error', `Lỗi: ${xhr.responseJSON?.message || 'Vui lòng thử lại!'}`),
            complete: () => $(`${modalId} button[type="submit"]`)
                .prop('disabled', false)
                .html(method === 'POST' ? 'Thêm sản phẩm' : 'Lưu thay đổi')
        });
    }

    $(document).ready(function() {
        loadData('/providers/json', '#providerId', 'fullName', 'nhà cung cấp');
        loadData('/providers/json', '#editProviderId', 'fullName', 'nhà cung cấp');
        loadData('/typeproduct/json', '#category', 'name', 'danh mục');
        loadData('/typeproduct/json', '#editCategory', 'name', 'danh mục');
        togglePriceInventoryFields(false);
        previewImage('#thumbnail', '#thumbnailPreview');
        previewImage('#editThumbnail', '#editThumbnailPreview');
        console.log('Trang sản phẩm đã tải xong');
    });

    // Mở trang biến thể
    function openVariantsPage(editMode = false) {
        isEditMode = editMode;
        const modalId = editMode ? '#editProductModal' : '#addProductModal';
        $(modalId).modal('hide');
        const typeProductId = editMode ? $('#editCategory').val() : $('#category').val();
        if (!typeProductId) {
            showToast('error', 'Vui lòng chọn danh mục trước khi chọn biến thể!');
            $(modalId).modal('show');
            return;
        }
        const url = `/products/variants?typeProductId=${typeProductId}`;
        console.log('Mở trang biến thể với URL:', url);
        const width = Math.min(1200, window.screen.width * 0.9);
        const height = Math.min(800, window.screen.height * 0.9);
        const left = (window.screen.width - width) / 2;
        const top = (window.screen.height - height) / 2;
        window.open(url, 'VariantsWindow', `width=${width},height=${height},left=${left},top=${top}`);
    }

    // Hiển thị chi tiết sản phẩm
    function showProductDetails(productId) {
        if (!productId || !/^[0-9a-fA-F]{24}$/.test(productId)) {
            console.log('ID sản phẩm không hợp lệ:', productId);
            showToast('error', 'ID sản phẩm không hợp lệ!');
            return;
        }
        
        console.log('Gọi chi tiết sản phẩm với ID:', productId);
        
        $.ajax({
            url: `/products/${productId}`,
            type: 'GET',
            dataType: 'json',
            success: function(response) {
                if (response.status === 'Ok') {
                    const product = response.data;
                    console.log('Dữ liệu sản phẩm nhận được:', product);
                    
                    // Cập nhật thông tin cơ bản
                    $('#productImage').attr('src', product.thumbnail || 'https://via.placeholder.com/100');
                    $('#productName').text(product.name || 'N/A');
                    $('#productCategory').text(product.category?.name || 'Chưa có');
                    $('#productProvider').text(product.providerId?.fullName || 'Chưa có');
                    
                    // Cập nhật thông tin bảo hành
                    const warrantyPeriod = product.warrantyPeriod || 12;
                    $('#productWarranty').html(`
                        <i class="fas fa-shield-alt me-1"></i>
                        ${warrantyPeriod} tháng
                    `);
                    
                    // Cập nhật trạng thái với icon và màu sắc
                    if (product.status === 'available') {
                        $('#productStatus').html('<span class="badge bg-success rounded-pill"><i class="fas fa-check-circle me-1"></i> Có sẵn</span>');
                    } else {
                        $('#productStatus').html('<span class="badge bg-danger rounded-pill"><i class="fas fa-times-circle me-1"></i> Hết hàng</span>');
                    }
                    
                    // Xử lý hiển thị biến thể
                    const variants = product.detailsVariants || [];
                    const hasVariants = product.hasVariants && variants.length > 0;
                    
                    // Hiển thị/ẩn giá và tồn kho cơ bản
                    $('#productBasicPriceRow, #productBasicInventoryRow').toggle(!hasVariants);
                    $('#productVariantsSection').toggle(hasVariants);
                    
                    if (!hasVariants) {
                        $('#productPrice').text(`${(product.price || 0).toLocaleString()} VNĐ`);
                        $('#productInventory').text(product.inventory ?? 'N/A');
                    }
                    
                    if (hasVariants) {
                        // Kiểm tra cấu trúc dữ liệu detailsVariants
                        console.log('Chi tiết biến thể:', variants);
                        
                        $('#productVariantsBody').empty();
                        
                        variants.forEach(variant => {
                            try {
                                // Kiểm tra xem variant có variantDetails không
                                if (!variant.variantDetails || !Array.isArray(variant.variantDetails)) {
                                    console.warn('Variant không có variantDetails hợp lệ:', variant);
                                    return;
                                }
                                
                                const variantDetailsContent = [];
                                
                                // Xử lý hiển thị từng chi tiết biến thể
                                variant.variantDetails.forEach(detail => {
                                    let variantName = '';
                                    let variantValue = '';
                                    
                                    if (detail.variantId && typeof detail.variantId === 'object') {
                                        variantName = detail.variantId.name || 'N/A';
                                    } else {
                                        variantName = 'N/A';
                                    }
                                    
                                    variantValue = detail.value || 'N/A';
                                    
                                    variantDetailsContent.push(`<strong>${variantName}:</strong> ${variantValue}`);
                                });
                                
                                const variantText = variantDetailsContent.join(', ');
                                const inventoryStatus = variant.inventory > 0 
                                    ? `<span class="badge bg-success rounded-pill">Còn hàng</span>` 
                                    : `<span class="badge bg-danger rounded-pill">Hết hàng</span>`;
                                
                                const row = `
                                    <tr>
                                        <td>${variantText}</td>
                                        <td class="text-end fw-bold">${(variant.price || 0).toLocaleString()} VNĐ</td>
                                        <td class="text-center">${variant.inventory ?? 0}</td>
                                        <td class="text-center">${inventoryStatus}</td>
                                    </tr>`;
                                    
                                $('#productVariantsBody').append(row);
                            } catch (error) {
                                console.error('Lỗi khi hiển thị biến thể:', error, variant);
                            }
                        });
                        
                        // Nếu không có dữ liệu hiển thị
                        if ($('#productVariantsBody').children().length === 0) {
                            $('#productVariantsBody').html('<tr><td colspan="4" class="text-center">Không có dữ liệu biến thể</td></tr>');
                        }
                    } else {
                        $('#productVariantsBody').html('<tr><td colspan="4" class="text-center">Sản phẩm không có biến thể</td></tr>');
                    }
                    
                    // Khi nhấn nút sửa
                    $('#btnEditProductDetail').off('click').on('click', function() {
                        $('#productDetailsModal').modal('hide');
                        editProduct(productId);
                    });
                    
                    // Hiển thị modal
                    $('#productDetailsModal').modal('show');
                } else {
                    showToast('error', `Lỗi khi lấy chi tiết sản phẩm: ${response.message}`);
                }
            },
            error: function(xhr) {
                console.error('Lỗi khi gọi API:', xhr);
                showToast('error', `Lỗi khi lấy chi tiết sản phẩm: ${xhr.responseJSON?.message || 'Vui lòng thử lại!'}`);
            }
        });
    }

    // Thêm sản phẩm
    $('#addProductForm').submit(function(event) {
        event.preventDefault();
        const hasVariants = selectedVariantsData.length > 0;
        if (!hasVariants && (!$('#price').val() || !$('#inventory').val())) {
            showToast('error', 'Vui lòng nhập giá và tồn kho khi không có biến thể!');
            return;
        }

        const formData = new FormData(this);
        formData.append('variantDetails', JSON.stringify(selectedVariantsData));
        console.log('Gửi yêu cầu thêm sản phẩm:', Object.fromEntries(formData.entries()));
        sendAjaxRequest('/products/create', 'POST', formData, 'Thêm sản phẩm thành công!', '#addProductModal', () => setTimeout(() => location.reload(), 1500));
    });

    // Sửa sản phẩm
    function editProduct(id) {
        if (!id || !/^[0-9a-fA-F]{24}$/.test(id)) {
            showToast('error', 'ID sản phẩm không hợp lệ!');
            return;
        }
        console.log('Gọi sửa sản phẩm với ID:', id);
        $.get(`/products/${id}`, function(response) {
            if (response.status === 'Ok') {
                const product = response.data;
                $('#editProductId').val(product._id);
                $('#editName').val(product.name);
                $('#editThumbnailPreview').attr('src', product.thumbnail || 'https://via.placeholder.com/100').show();
                $('#editCategory').val(product.category?._id || '');
                $('#editProviderId').val(product.providerId?._id || '');
                $('#editStatus').val(product.status);

                selectedVariantsData = product.hasVariants && product.detailsVariants?.length > 0
                    ? product.detailsVariants.map(variant => ({
                        variantDetails: variant.variantDetails.map(d => ({ variantId: d.variantId._id, value: d.value })),
                        price: variant.price,
                        inventory: variant.inventory
                    }))
                    : [];
                if (selectedVariantsData.length > 0) {
                    const displayText = selectedVariantsData.map(v => v.variantDetails.map(d => d.value).join(', ')).join('; ');
                    $('#editSelectedVariantDisplay').text(`Đã chọn: ${displayText}`).show();
                    $('#editVariantDetails').val(JSON.stringify(selectedVariantsData));
                    togglePriceInventoryFields(true, true);
                } else {
                    $('#editSelectedVariantDisplay').hide();
                    $('#editPrice').val(product.price || '');
                    $('#editInventory').val(product.inventory || '');
                    togglePriceInventoryFields(false, true);
                }
                $('#editProductModal').modal('show');
            } else {
                showToast('error', `Lỗi khi lấy thông tin sản phẩm: ${response.message}`);
            }
        }).fail(() => showToast('error', 'Lỗi khi lấy thông tin sản phẩm!'));
    }

    $('#editProductForm').submit(function(event) {
        event.preventDefault();
        const hasVariants = selectedVariantsData.length > 0;
        if (!hasVariants && (!$('#editPrice').val() || !$('#editInventory').val())) {
            showToast('error', 'Vui lòng nhập giá và tồn kho khi không có biến thể!');
            return;
        }

        const formData = new FormData(this);
        formData.append('variantDetails', JSON.stringify(selectedVariantsData));
        console.log('Gửi yêu cầu cập nhật sản phẩm:', Object.fromEntries(formData.entries()));
        sendAjaxRequest(`/products/update/${$('#editProductId').val()}`, 'PUT', formData, 'Cập nhật sản phẩm thành công!', '#editProductModal', () => setTimeout(() => location.reload(), 1500));
    });

    // Nhận dữ liệu biến thể từ variants.ejs
    window.addEventListener('message', function(event) {
        if (event.data.selectedVariants && Array.isArray(event.data.selectedVariants)) {
            console.log('Nhận dữ liệu biến thể từ variants:', event.data.selectedVariants);
            
            // Chuẩn hóa dữ liệu từ trang variants.ejs
            let variants = event.data.selectedVariants;
            
            // Kiểm tra và lọc ra các tổ hợp biến thể hợp lệ
            variants = variants.filter(combination => 
                Array.isArray(combination) && combination.length > 0 && 
                combination.every(v => v.variantId && v.value)
            );
            
            if (variants.length === 0) {
                showToast('error', 'Không có biến thể hợp lệ được chọn!');
                $(isEditMode ? '#editProductModal' : '#addProductModal').modal('show');
                return;
            }

            // Render form nhập giá và tồn kho cho từng tổ hợp biến thể
            $('#variantPriceRows').empty();
            variants.forEach((combination, index) => {
                // Lấy tên hiển thị cho tổ hợp: kết hợp các giá trị biến thể
                const variantText = combination.map(v => v.value).join(', ');
                
                $('#variantPriceRows').append(`
                    <div class="mb-3 p-3 border rounded">
                        <h6 class="fw-bold mb-2">Tổ hợp #${index + 1}: ${variantText}</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Giá (VNĐ)</label>
                                <input type="number" class="form-control" name="price-${index}" placeholder="Giá (VNĐ)" min="0" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Tồn kho</label>
                                <input type="number" class="form-control" name="inventory-${index}" placeholder="Tồn kho" min="0" required>
                            </div>
                        </div>
                    </div>`);
            });

            // Xử lý khi submit form giá và tồn kho
            $('#variantPriceForm').off('submit').on('submit', function(e) {
                e.preventDefault();
                const prices = $('[name^="price-"]').map((i, el) => Number(el.value)).get();
                const inventories = $('[name^="inventory-"]').map((i, el) => Number(el.value)).get();
                
                if (prices.some(p => p < 0 || isNaN(p)) || inventories.some(i => i < 0 || isNaN(i))) {
                    showToast('error', 'Giá và tồn kho phải là số không âm!');
                    return;
                }

                // Tạo dữ liệu cho các tổ hợp biến thể
                selectedVariantsData = variants.map((combination, index) => ({
                    variantDetails: combination,
                    price: prices[index],
                    inventory: inventories[index]
                }));
                
                // Tạo text hiển thị cho các tổ hợp đã chọn
                const displayText = selectedVariantsData.map((variant, index) => 
                    `Tổ hợp #${index + 1}: ${variant.variantDetails.map(d => d.value).join(', ')} - ${variant.price.toLocaleString()} VNĐ`
                ).join('<br>');
                
                const target = isEditMode ? '#editSelectedVariantDisplay' : '#selectedVariantDisplay';
                const hiddenInput = isEditMode ? '#editVariantDetails' : '#variantDetails';
                
                $(target).html(`<div class="alert alert-info">Đã chọn:<br>${displayText}</div>`).show();
                $(hiddenInput).val(JSON.stringify(selectedVariantsData));
                togglePriceInventoryFields(true, isEditMode);
                $('#variantPriceModal').modal('hide');
                $(isEditMode ? '#editProductModal' : '#addProductModal').modal('show');
            });
            
            $('#variantPriceModal').modal('show');
        }
    });

    // Filter functionality
    $('#applyFilter').click(function () {
        const providerId = $('#providerFilter').val();
        const categoryId = $('#categoryFilter').val();
        const status = $('#statusFilter').val();
        const search = $('#searchInput').val().toLowerCase();

        $('tbody tr').each(function () {
            const row = $(this);
            const rowProviderId = row.find('td:eq(6)').attr('data-provider-id');
            const rowCategoryId = row.find('td:eq(2)').attr('data-category-id');
            const rowStatus = row.find('td:eq(3)').text().trim().toLowerCase();
            const rowName = row.find('td:eq(0)').text().trim().toLowerCase();

            const providerMatch = !providerId || rowProviderId === providerId;
            const categoryMatch = !categoryId || rowCategoryId === categoryId;
            const statusMatch = !status || 
                (status === 'available' && rowStatus.includes('có sẵn')) ||
                (status === 'unavailable' && rowStatus.includes('hết hàng'));
            const searchMatch = !search || rowName.includes(search);

            if (providerMatch && categoryMatch && statusMatch && searchMatch) {
                row.show();
            } else {
                row.hide();
            }
        });
    });

    // Reset filter functionality
    $('#resetFilter').click(function () {
        $('#providerFilter').val('');
        $('#categoryFilter').val('');
        $('#statusFilter').val('');
        $('#searchInput').val('');
        $('tbody tr').show();
    });

    // Apply filter on search input change
    $('#searchInput').on('input', function() {
        $('#applyFilter').click();
    });

    // Apply filter on select change
    $('#providerFilter, #categoryFilter, #statusFilter').change(function() {
        $('#applyFilter').click();
    });
</script>